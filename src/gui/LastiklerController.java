package gui;

import database.DatabaseConnection;
import database.DatabaseFunctions;
import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.geometry.Insets;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;
import javafx.util.Pair;
import model.Lastik;
import model.MusteriLite;
import org.controlsfx.control.table.TableFilter;
import java.sql.*;

/**
 * Stoktaki lastikleri g√∂sterir ve stok / satƒ±≈ü / iade i≈ülemlerini y√∂netir.
 */
public class LastiklerController {

    @FXML private TableView<Lastik> tableLastikler;
    @FXML private TableColumn<Lastik, String> colMarka;
    @FXML private TableColumn<Lastik, String> colTip;
    @FXML private TableColumn<Lastik, String> colEbat;
    @FXML private TableColumn<Lastik, String> colHiz;
    @FXML private TableColumn<Lastik, String> colYuk;
    @FXML private TableColumn<Lastik, Double> colAlis;
    @FXML private TableColumn<Lastik, Double> colSatis;
    @FXML private TableColumn<Lastik, Integer> colAdet;
    @FXML private TableColumn<Lastik, String> colTarih;

    private final ObservableList<Lastik> lastikListesi = FXCollections.observableArrayList();

    // ======================================================
    //  BA≈ûLATMA
    // ======================================================
    @FXML
    public void initialize() {
        // üîπ Tablo s√ºtunlarƒ±nƒ± model property‚Äôleriyle e≈üle≈ütir
        colMarka.setCellValueFactory(data -> data.getValue().markaProperty());
        colTip.setCellValueFactory(data -> data.getValue().tipProperty());
        colEbat.setCellValueFactory(data -> data.getValue().ebatProperty());
        colHiz.setCellValueFactory(data -> data.getValue().hizProperty());
        colYuk.setCellValueFactory(data -> data.getValue().yukProperty());
        colAlis.setCellValueFactory(data -> data.getValue().alisFiyatiProperty().asObject());
        colSatis.setCellValueFactory(data -> data.getValue().satisFiyatiProperty().asObject());
        colAdet.setCellValueFactory(data -> data.getValue().adetProperty().asObject());
        colTarih.setCellValueFactory(data -> data.getValue().tarihProperty());

        // üîπ Tablo verilerini y√ºkle
        lastikleriYukle();

        // üîπ Filtre uygula
        Platform.runLater(() -> TableFilter.forTableView(tableLastikler).apply());

        // üîπ Ortak layout yenileme (tam ekran uyumlu)
        LayoutRefresher.refresh(tableLastikler);
    }

    // ======================================================
    //  Lƒ∞STEYƒ∞ Y√úKLE
    // ======================================================
    private void lastikleriYukle() {
        lastikListesi.clear();

        String sql = """
                SELECT
                    u.id,
                    m.markaAdi AS marka,
                    t.tip AS tip,
                    CONCAT(e.genislik, '/', e.yukseklik, ' R', e.jant) AS ebat,
                    h.hizEndeks AS hiz,
                    y.yukEndeks AS yuk,
                    u.alisFiyati,
                    u.satisFiyati,
                    u.adet,
                    FORMAT(u.eklenmeTarihi, 'dd.MM.yyyy') AS tarih
                FROM urunler u
                JOIN markalar m ON u.markaId = m.id
                JOIN tipler t ON u.tipId = t.id
                JOIN ebatlar e ON u.ebatId = e.id
                JOIN hizEndeksleri h ON u.hizEndeksId = h.id
                JOIN yukEndeksleri y ON u.yukEndeksId = y.id
                WHERE u.aktif = 1
                ORDER BY u.eklenmeTarihi DESC;
                """;

        try (Connection conn = DatabaseConnection.baglan();
             Statement st = conn.createStatement();
             ResultSet rs = st.executeQuery(sql)) {

            while (rs.next()) {
                lastikListesi.add(new Lastik(
                        rs.getInt("id"),
                        rs.getString("marka"),
                        rs.getString("tip"),
                        rs.getString("ebat"),
                        rs.getString("hiz"),
                        rs.getString("yuk"),
                        rs.getDouble("alisFiyati"),
                        rs.getDouble("satisFiyati"),
                        rs.getInt("adet"),
                        rs.getString("tarih")
                ));
            }

            tableLastikler.setItems(lastikListesi);

        } catch (Exception e) {
            hataMesaji("Veriler y√ºklenirken hata olu≈ütu:\n" + e.getMessage());
        }
    }

    // ======================================================
    //  STOK ARTIR
    // ======================================================
    @FXML
    private void handleUrunGuncelle() {
        Lastik secilen = tableLastikler.getSelectionModel().getSelectedItem();
        if (secilen == null) {
            showWarning("√úr√ºn G√ºncelleme", "L√ºtfen √∂nce bir √ºr√ºn se√ßin.");
            return;
        }

        Dialog<Pair<String[], String>> dialog = new Dialog<>();
        dialog.setTitle("√úr√ºn G√ºncelle");
        dialog.setHeaderText("Se√ßilen √ºr√ºn: " + secilen.getMarka() + " " + secilen.getTip());

        ButtonType okButtonType = new ButtonType("Kaydet", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(okButtonType, ButtonType.CANCEL);

        GridPane grid = new GridPane();
        grid.setHgap(10);
        grid.setVgap(10);
        grid.setPadding(new Insets(20, 150, 10, 10));

        TextField adetField = new TextField();
        adetField.setPromptText("Yeni adet (isteƒüe baƒülƒ±)");

        TextField alisField = new TextField();
        alisField.setPromptText("Yeni alƒ±≈ü fiyatƒ± (isteƒüe baƒülƒ±)");

        TextField satisField = new TextField();
        satisField.setPromptText("Yeni satƒ±≈ü fiyatƒ± (isteƒüe baƒülƒ±)");

        grid.add(new Label("Yeni adet:"), 0, 0);
        grid.add(adetField, 1, 0);
        grid.add(new Label("Yeni alƒ±≈ü fiyatƒ±:"), 0, 1);
        grid.add(alisField, 1, 1);
        grid.add(new Label("Yeni satƒ±≈ü fiyatƒ±:"), 0, 2);
        grid.add(satisField, 1, 2);

        dialog.getDialogPane().setContent(grid);
        Platform.runLater(adetField::requestFocus);

        dialog.setResultConverter(dialogButton -> {
            if (dialogButton == okButtonType) {
                return new Pair<>(new String[]{adetField.getText(), alisField.getText(), satisField.getText()}, "");
            }
            return null;
        });

        dialog.showAndWait().ifPresent(result -> {
            String[] values = result.getKey();
            String adetStr = values[0].trim();
            String alisStr = values[1].trim();
            String satisStr = values[2].trim();

            if (adetStr.isEmpty() && alisStr.isEmpty() && satisStr.isEmpty()) {
                showWarning("Bo≈ü G√ºncelleme", "G√ºncellemek i√ßin en az bir alan doldurun.");
                return;
            }

            StringBuilder sql = new StringBuilder("UPDATE urunler SET ");
            boolean first = true;

            if (!adetStr.isEmpty()) {
                sql.append("adet = ?");
                first = false;
            }
            if (!alisStr.isEmpty()) {
                if (!first) sql.append(", ");
                sql.append("alisFiyati = ?");
                first = false;
            }
            if (!satisStr.isEmpty()) {
                if (!first) sql.append(", ");
                sql.append("satisFiyati = ?");
            }

            sql.append(", guncellenmeTarihi = GETDATE() WHERE id = ?");

            try (Connection conn = DatabaseConnection.baglan();
                 PreparedStatement ps = conn.prepareStatement(sql.toString())) {

                int index = 1;

                if (!adetStr.isEmpty()) {
                    ps.setInt(index++, Integer.parseInt(adetStr));
                }
                if (!alisStr.isEmpty()) {
                    ps.setDouble(index++, Double.parseDouble(alisStr));
                }
                if (!satisStr.isEmpty()) {
                    ps.setDouble(index++, Double.parseDouble(satisStr));
                }

                ps.setInt(index, secilen.getId());
                ps.executeUpdate();

                bilgiMesaji("√úr√ºn bilgileri ba≈üarƒ±yla g√ºncellendi!");
                lastikleriYukle();

            } catch (NumberFormatException e) {
                hataMesaji("L√ºtfen ge√ßerli sayƒ± formatƒ± kullanƒ±n.");
            } catch (Exception e) {
                hataMesaji("√úr√ºn g√ºncellenirken hata olu≈ütu:\n" + e.getMessage());
            }
        });
    }


    // ======================================================
    //  SATI≈û YAP (TOPLU VE KESƒ∞N D√úZELTME)
    // ======================================================
    @FXML
    private void handleSatisYap() {
        Lastik seciliLastik = tableLastikler.getSelectionModel().getSelectedItem();
        if (seciliLastik == null) {
            showWarning("√úr√ºn Se√ßilmedi", "L√ºtfen satƒ±≈ü yapmak i√ßin bir √ºr√ºn se√ßin.");
            return;
        }

        ObservableList<MusteriLite> musterilerlite = DatabaseFunctions.musterileriGetirLite();

        // üîπ Haritayƒ± bir kez olu≈ütur (performans i√ßin)
        MusteriLite.initializeMap(musterilerlite);

        if (musterilerlite == null || musterilerlite.isEmpty()) {
            showWarning("M√º≈üteri Yok", "Veritabanƒ±nda kayƒ±tlƒ± m√º≈üteri bulunamadƒ±. L√ºtfen √∂nce bir m√º≈üteri ekleyin.");
            return;
        }

        Dialog<ButtonType> dialog = new Dialog<>();
        dialog.setTitle("Satƒ±≈ü ƒ∞≈ülemi");
        dialog.setHeaderText("Se√ßilen √úr√ºn: " + seciliLastik.getMarka() + " - " + seciliLastik.getTip());

        ComboBox<MusteriLite> comboMusterilite = new ComboBox<>();
        comboMusterilite.setEditable(true);
        comboMusterilite.setPromptText("M√º≈üteri Se√ß veya Ara...");
        comboMusterilite.setPrefWidth(320);

        FilteredList<MusteriLite> filtreliListe = new FilteredList<>(musterilerlite, p -> true);
        comboMusterilite.setItems(filtreliListe);

        // üîπ Satƒ±lacak adet alanƒ±
        TextField txtAdet = new TextField();
        txtAdet.setPromptText("Satƒ±lacak adet");
        txtAdet.setPrefWidth(150);

        // üîπ Birim fiyat alanƒ±
        TextField txtBirimFiyat = new TextField();
        double birimFiyat = seciliLastik.getSatisFiyati();
        txtBirimFiyat.setText(String.format("%.2f", birimFiyat));
        txtBirimFiyat.setPrefWidth(150);
        txtBirimFiyat.setEditable(false); // elle deƒüi≈ütirilemez

        // üîπ Toplam tutar alanƒ± (otomatik hesaplanƒ±r)
        TextField txtToplam = new TextField();
        txtToplam.setPromptText("Toplam Tutar (‚Ç∫)");
        txtToplam.setPrefWidth(150);

        TextField txtAlinan = new TextField();
        txtAlinan.setPromptText("Alinan Tutar (‚Ç∫)");
        txtAlinan.setPrefWidth(150);

        // üîπ Sadece adet deƒüi≈ütiƒüinde otomatik toplam hesaplama
        txtAdet.textProperty().addListener((obs, oldVal, newVal) -> {
            try {
                int adet = Integer.parseInt(newVal);
                double toplam = adet * birimFiyat;
                txtToplam.setText(String.format("%.2f", toplam));
            } catch (NumberFormatException e) {
                txtToplam.clear(); // Ge√ßersiz sayƒ± girilirse temizle
            }
        });

        // üîπ Formu bir araya getir
        VBox content = new VBox(10);
        content.getChildren().addAll(
                new Label("M√º≈üteri Se√ß:"), comboMusterilite,
                new Label("Satƒ±lacak Adet:"), txtAdet,
                new Label("Birim Fiyat:"), txtBirimFiyat,
                new Label("Toplam Tutar:"), txtToplam,
                new Label("Alƒ±nan Tutar:"), txtAlinan
        );
        dialog.getDialogPane().setContent(content);

        // Butonlarƒ± ekle
        ButtonType satBtn = new ButtonType("Sat", ButtonBar.ButtonData.OK_DONE);
        ButtonType iptalBtn = new ButtonType("ƒ∞ptal", ButtonBar.ButtonData.CANCEL_CLOSE);
        dialog.getDialogPane().getButtonTypes().addAll(satBtn, iptalBtn);

        // üîπ Diyalog g√∂sterilir ve kullanƒ±cƒ± bir se√ßim yaparsa burada d√∂ner
        dialog.showAndWait().ifPresent(result -> {
            if (result == satBtn) {
                Object m = comboMusterilite.getSelectionModel().getSelectedItem();
                if (m != null) {
                    Object secilenAd = comboMusterilite.getSelectionModel().getSelectedItem();
                    long musteriId = MusteriLite.getIdFromGorunenAd(secilenAd);
                    long urunId = seciliLastik.getId();

                    try {
                        // üîπ Bo≈ü veya hatalƒ± giri≈üleri √∂nle
                        String adetStr = txtAdet.getText().trim();
                        String toplamStr = txtToplam.getText().trim().replace(",", ".");
                        String alinanStr = txtAlinan.getText().trim().replace(",", ".");

                        // üîπ Bo≈ü olanlarƒ± 0 yap
                        if (adetStr.isEmpty()) adetStr = "0";
                        if (toplamStr.isEmpty()) toplamStr = "0";
                        if (alinanStr.isEmpty()) alinanStr = "0";

                        // üîπ T√ºr d√∂n√º≈ü√ºmleri
                        int adet = Integer.parseInt(adetStr);
                        double toplamTutar = Double.parseDouble(toplamStr);
                        double alinanTutar = Double.parseDouble(alinanStr);

                        // üîπ Kalan tutar
                        double kalan = toplamTutar - alinanTutar;

                        boolean odendi = false;

                        if(kalan == 0){
                            odendi = true;
                        }

                        // üîπ Konsola yaz
                        System.out.println("Se√ßilen Lastik ID  : " + urunId);
                        System.out.println("Se√ßilen M√º≈üteri ID : " + musteriId);
                        System.out.println("Adet          : " + adet);
                        System.out.println("Toplam Tutar  : " + String.format("%.2f", toplamTutar) + " ‚Ç∫");
                        System.out.println("Alƒ±nan Tutar  : " + String.format("%.2f", alinanTutar) + " ‚Ç∫");
                        System.out.println("Kalan         : " + String.format("%.2f", kalan) + " ‚Ç∫");
                        System.out.println("√ñdendi        : " + odendi);

                        if(adet > seciliLastik.getAdet()){
                            showWarning("Stok A≈üƒ±mƒ±", "Stokta Yeterli √úr√ºn Yok.\nMevcut Stok: " + seciliLastik.getAdet());
                            return;
                        }

                        boolean satisEklendi = DatabaseFunctions.satisEkle(urunId, musteriId, adet, toplamTutar, alinanTutar, odendi);
                        bilgiMesaji("Satƒ±≈ü Ba≈üarƒ±yla Yapƒ±ldƒ±.");
                        lastikleriYukle();

                    } catch (Exception e) {
                        System.out.println("‚ö†Ô∏è L√ºtfen sayƒ±sal alanlara sadece sayƒ± girin!");
                    }
                } else {
                    showWarning("M√º≈üteri Se√ßilmedi", "L√ºtfen bir m√º≈üteri se√ßin.");
                }
            }
        });
    }

    // ======================================================
    //  ƒ∞ADE ET
    // ======================================================
    @FXML
    private void handleIadeEt() { // üîπ Bu metot artƒ±k FXML'de tanƒ±mlƒ±!
        Lastik secilen = tableLastikler.getSelectionModel().getSelectedItem();
        if (secilen == null) {
            showWarning("ƒ∞ade ƒ∞≈ülemi", "L√ºtfen √∂nce bir √ºr√ºn se√ßin.");
            return;
        }

        TextInputDialog dialog = new TextInputDialog();
        dialog.setTitle("ƒ∞ade Et");
        dialog.setHeaderText("Se√ßilen √ºr√ºn: " + secilen.getMarka() + " " + secilen.getTip());
        dialog.setContentText("ƒ∞ade edilecek adet miktarƒ±nƒ± girin:");

        dialog.showAndWait().ifPresent(giris -> {
            try {
                int iade = Integer.parseInt(giris);
                if (iade <= 0) throw new NumberFormatException();
                if (iade > secilen.getAdet()) {
                    showWarning("Ge√ßersiz Miktar", "ƒ∞ade miktarƒ± stoktan fazla olamaz!");
                    return;
                }

                String sql = "UPDATE urunler SET adet = adet - ?, guncellenmeTarihi = GETDATE() WHERE id = ?";
                try (Connection conn = DatabaseConnection.baglan();
                     PreparedStatement ps = conn.prepareStatement(sql)) {
                    ps.setInt(1, iade);
                    ps.setInt(2, secilen.getId());
                    ps.executeUpdate();
                }

                bilgiMesaji("Stoktan " + iade + " adet iade edildi!");
                lastikleriYukle();

            } catch (Exception e) {
                hataMesaji("ƒ∞ade sƒ±rasƒ±nda hata olu≈ütu:\n" + e.getMessage());
            }
        });
    }

    // ======================================================
    //  GERƒ∞ D√ñN
    // ======================================================
    @FXML
    private void handleGeri() {
        try {
            Parent root = FXMLLoader.load(getClass().getResource("/gui/Panel.fxml"));
            Stage stage = (Stage) tableLastikler.getScene().getWindow();
            stage.setScene(new Scene(root));
            stage.setTitle("Yƒ±lmaz & √únal Oto Lastik - Ana Panel");
        } catch (Exception e) {
            hataMesaji("Panele geri d√∂n√ºl√ºrken hata olu≈ütu:\n" + e.getMessage());
        }
    }

    // ======================================================
    //  MESAJLAR
    // ======================================================
    private void showWarning(String baslik, String mesaj) {
        Alert alert = new Alert(Alert.AlertType.WARNING);
        alert.setTitle(baslik);
        alert.setHeaderText(null);
        alert.setContentText(mesaj);
        alert.showAndWait();
    }

    private void bilgiMesaji(String mesaj) {
        Alert info = new Alert(Alert.AlertType.INFORMATION);
        info.setTitle("Bilgi");
        info.setHeaderText(null);
        info.setContentText(mesaj);
        info.showAndWait();
    }

    private void hataMesaji(String mesaj) {
        Alert err = new Alert(Alert.AlertType.ERROR);
        err.setTitle("Hata");
        err.setHeaderText(null);
        err.setContentText(mesaj);
        err.showAndWait();
    }
}
